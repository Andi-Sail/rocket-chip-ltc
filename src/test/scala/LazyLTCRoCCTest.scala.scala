
import chisel3._
import chiseltest._
import org.scalatest.flatspec.AnyFlatSpec
import freechips.rocketchip.tile.{LTCUnit, HardSigmoid}
import org.scalatest.funsuite.AnyFunSuite

import  Array._
import scala.math._


// sigmoid test independed of HW implementation
class SigmoidLUTTest extends AnyFlatSpec with ChiselScalatestTester {
  behavior of "HardSigmoid" 
  it should "generate a correct fix16 error LUT" in {
    test(
      new HardSigmoid(w=32, f=16, lut_addr_w=6)
      ) { c =>
        // expected LUTs generated with: python3 GenerateSigmoidErrorLut.py -e 0.001 -l 64
        println("Checking float LUT")
        val exp_lut_f = Array(-0.0,4.0626626243711605e-05,0.00032349911420193056,0.0010834000459303272,0.002540668798145407,0.00489513533394581,0.008321300824607025,0.012964972162988753,0.018941421369995104,0.026335013132371743,0.035200138825308924,0.04556322226037879,0.05742552380635635,0.07076646289656308,0.08554719803168942,0.10171424019782938,0.11920292202211769,0.10669059394565128,0.09534946489910945,0.08509904500702026,0.07585818002124345,0.06754669113962908,0.060086650174007605,0.05340332979982432,0.047425873177566635,0.04208772791561888,0.03732688734412937,0.033085978388704196,0.02931223075135636,0.025957357197796904,0.022977369910025636,0.020332353342658815,0.01798620996209155,0.015906391711814738,0.014063627043245597,0.012431650853185872,0.010986942630593188,0.009708476481474104,0.00857748541371195,0.007577241267860746,0.006692850924284732,0.005911068856243817,0.005220125693558342,0.004609572179374077,0.004070137715896038,0.0035936025814201633,0.003172682842485175,0.002800926967121087,0.002472623156634657,0.0021827164453452896,0.0019267346633274895,0.0017007224114351516,0.0015011822567370103,0.0013250224172132175,0.0011695102650555178,0.0010322310367547605,0.0009110511944006028,0.0008040859356291952,0.000709670399100526,0.0006263341581095316,0.000552778636923601,0.0004878571227822093,0.0004305570813245563,0.00037998451475196315)
        val act_lut_f = c.error_lut_d
        for ( i <- 0 until 64)
        {
          assert(exp_lut_f(i) == act_lut_f(i), s"error float lut missmatch $i")
        }

        val exp_lut_fix = Array(0,3,21,71,167,321,545,850,1241,1726,2307,2986,3763,4638,5606,6666,7812,6992,6249,5577,4971,4427,3938,3500,3108,2758,2446,2168,1921,1701,1506,1333,1179,1042,922,815,720,636,562,497,439,387,342,302,267,236,208,184,162,143,126,111,98,87,77,68,60,53,47,41,36,32,28,25)
        val act_lut_fix = c.error_lut_quant
        println("Checking fix16 LUT")
        for ( i <- 0 until 64)
        {
          // round to four digits, due to double <-> float difference
          assert(exp_lut_fix(i) == act_lut_fix(i), s"error fix lut missmatch $i")
        }
    }
  }
  it should "generate a correct fix8 error LUT" in {
    test(
      new HardSigmoid(w=16, f=8, lut_addr_w=7)
      ) { c =>
        // expected LUTs generated with: python3 GenerateSigmoidErrorLut.py -e 0.01 -l 128
        println("Checking float LUT")
        val exp_lut_f = Array(-0.0,5.08427698442393e-06,4.0626626243711605e-05,0.00013684801538615954,0.00032349911420193056,0.0006296348141882069,0.0010834000459303272,0.001711830167108297,0.002540668798145407,0.0035942055196168665,0.00489513533394581,0.006464441253186015,0.008321300824607025,0.010483016865263872,0.012964972162988753,0.01578060742914389,0.018941421369995104,0.022456991387518888,0.026335013132371743,0.030581356914040292,0.035200138825308924,0.04019380435710529,0.04556322226037879,0.05130778644723677,0.05742552380635635,0.06391320592932659,0.07076646289656308,0.07797989744545741,0.08554719803168942,0.09346124949008328,0.10171424019782938,0.11029776483513232,0.11920292202211769,0.1127954062828932,0.10669059394565128,0.10087862273005643,0.09534946489910945,0.0900929939619518,0.08509904500702026,0.08035746882220707,0.07585818002124345,0.07159119944455239,0.06754669113962908,0.06371499425196536,0.060086650174007605,0.056652425307973875,0.05340332979982432,0.05033063259747683,0.047425873177566635,0.04468087027265022,0.04208772791561888,0.03963883910096999,0.03732688734412937,0.035144846400793295,0.033085978388704196,0.031143830534778427,0.02931223075135636,0.02758528222679013,0.025957357197796904,0.024423090054107144,0.022977369910025636,0.0216153327626476,0.020332353342658815,0.019124036750888807,0.01798620996209155,0.01691491326672656,0.015906391711814738,0.014957086593149982,0.014063627043245597,0.013222821752305158,0.012431650853185872,0.011687257995694367,0.010986942630593188,0.010328152519305078,0.009708476481474104,0.009125637389180596,0.00857748541371195,0.008061991528271584,0.007577241267860746,0.00712142874573507,0.006692850924284732,0.006289902136892511,0.005911068856243817,0.005554924703691011,0.005220125693558342,0.004905405705722066,0.004609572179374077,0.004331502020563871,0.004070137715896038,0.0038244836446372776,0.0035936025814201633,0.0033766123817393634,0.003172682842485175,0.002981032729854838,0.002800926967121087,0.0026316739748845075,0.002472623156634657,0.002323162522631206,0.0021827164453452896,0.00205074353991741,0.0019267346633274895,0.0018102110262026017,0.0017007224114351516,0.0015978454940173137,0.0015011822567370103,0.0014103584966180804,0.0013250224172132175,0.0012448433020884053,0.0011695102650555178,0.0010987310729246857,0.0010322310367547605,0.000969751967782595,0.0009110511944006028,0.0008559006367451216,0.0008040859356291952,0.0007554056327294667,0.000709670399100526,0.0006667023092434832,0.0006263341581095316,0.0005884088185569292,0.000552778636923601,0.0005193048644950293,0.0004878571227822093,0.0004583129006350273,0.0004305570813245563,0.00040448149784211296,0.00037998451475196315,0.0003569706350377011)
        val act_lut_f = c.error_lut_d
        for ( i <- 0 until 64)
        {
          assert(exp_lut_f(i) == act_lut_f(i), s"error float lut missmatch $i")
        }

        val exp_lut_fix = Array(0,0,0,0,0,0,0,0,1,1,1,2,2,3,3,4,5,6,7,8,9,10,12,13,15,16,18,20,22,24,26,28,31,29,27,26,24,23,22,21,19,18,17,16,15,15,14,13,12,11,11,10,10,9,8,8,8,7,7,6,6,6,5,5,5,4,4,4,4,3,3,3,3,3,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)
        val act_lut_fix = c.error_lut_quant
        println("Checking fix8 LUT")
        for ( i <- 0 until 64)
        {
          // round to four digits, due to double <-> float difference
          assert(exp_lut_fix(i) == act_lut_fix(i), s"error fix lut missmatch $i")
        }
    }
  }
}


class BasicTest extends AnyFlatSpec with ChiselScalatestTester {
  behavior of "LTCUnit"
  // test class body here
  it should "do something" in {
    // test case body here
    test(new LTCUnit) { c =>
    // test body here
      c.io.in.poke(0.U)
      c.clock.step()
      c.io.out.expect(0.U)
      c.io.in.poke(42.U)
      c.clock.step()
      c.io.out.expect(42.U)
      println("Last output value :" + c.io.out.peek().litValue)
    }
  }
}